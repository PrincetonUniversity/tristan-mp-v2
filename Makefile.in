# Template for `Tristan v2` Makefile
SHELL=/bin/sh

# Files for conditional compilation
USER_FILE = @USER_FILE@

# General compiler specifications
FC := @COMPILER_COMMAND@
FFLAGS := @COMPILER_FLAGS@
PFLAGS := @PREPROCESSOR_FLAGS@
WARNFLAGS := @WARNING_FLAGS@

PFLAGS += @DEFS@
# FFLAGS += $(WARNFLAGS)

# Preliminary definitions
EXE_FILE := @EXE_NAME@
USR_DIR := @USER_DIR@
SRC_DIR := src/
BIN_DIR := bin/
BUILD_DIR := build/

EXECUTABLE := $(BIN_DIR)$(EXE_FILE)

SRC_FILES := $(shell find $(SRC_DIR) -name '*.F90') $(addprefix $(USR_DIR), $(USER_FILE).F90)
INC_FILES := $(shell find $(SRC_DIR) -name '*.F08') 
OBJ_FILES := $(patsubst %.F90,%.o,$(SRC_FILES))
OBJ_FILES := $(addprefix $(BUILD_DIR),$(OBJ_FILES))

.PHONY: all depend clean

all : depend $(EXECUTABLE)

-include Makefile.depend

depend Makefile.depend:
	@-./extern/makedepf90 $(SRC_FILES) -DUSROUTPUT -B $(BUILD_DIR) > Makefile.depend

$(EXECUTABLE): $(OBJ_FILES)
	@echo Linking $(EXECUTABLE)
	@mkdir -p $(@D)
	@$(FC) $(FFLAGS) $(PFLAGS) $(OBJ_FILES) -o $(EXECUTABLE)
	@echo [OK]: executable created at $(EXECUTABLE)
	

$(BUILD_DIR)%.o: %.F90
	@mkdir -p $(@D)
	@$(FC) $(FFLAGS) $(PFLAGS) -cpp $(addprefix -I, $(dir $(INC_FILES))) @MODULE@ $(BUILD_DIR) -c $< -o $@
	@echo [OK]: compiled $<

clean :
	@echo "Cleaning ..."
	@rm -f $(EXECUTABLE) $(OBJ_FILES)
	@rm -rf $(BIN_DIR) $(BUILD_DIR)
	@rm -f Makefile.depend
